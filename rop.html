<!DOCTYPE html>
<html>
    <head>
        <title>Ruminations on proxy</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="created" content="2018-04-25T15:00:22+0800"/>
        <meta name="modified" content="2018-04-26T16:28:32+0800"/>
        <meta name="tags" content=""/>
        <meta name="last device" content="liâ€™s MacBook Pro"/>
    </head>
    <body>
        <div class="note-wrapper">
            <h1>Ruminations on proxy</h1>
<p><i>by è‹ç«‹ Apr 25, 2018</i></p>
<br>
<h2>Abstract</h2>
<p>åœ¨è¿‡å»çš„ä¸¤å¹´åŠé‡Œ, æˆ‘åˆ†åˆ«åœ¨ä¸¤å®¶å…¬å¸, æŠ•å…¥æ¥è¿‘ä¸¤å¹´æ—¶é—´å…¨åŠ›ç‹¬ç«‹è®¾è®¡ç¼–å†™äº†ä¸¤ä¸ªåŸºäºtcpçš„proxyåº”ç”¨: ä¸€ä¸ªæ•°æ®åº“ä¸­é—´ä»¶dbproxyï¼Œä¸€ä¸ªiot gateway. ä¸¤ä¸ªé¡¹ç›®ä»ä¸šåŠ¡è™½ç„¶æœ‰è¾ƒå¤§å·®å¼‚, ä½†æŠ€æœ¯ä¸Šæœ‰é€šæ€§çš„åœ°æ–¹, å› ä¸ºä¹‹å‰ä»æœªåšè¿‡ç±»ä¼¼é¡¹ç›®, è‡ªå·±æŠ•å…¥æŒºå¤šæ—¶é—´ä»0å­¦ä¹ äº†å¾ˆå¤šæ–°çŸ¥è¯†å¹¶åœ¨é¡¹ç›®ä¸­æˆåŠŸåº”ç”¨. æ‰€ä»¥æœ¬æ–‡å°†å°è¯•ä¸€èµ·æ€»ç»“ä¸‹ä¸¤ä¸ªé¡¹ç›®è‡ªå·±è§‰å¾—æ”¶è·å’Œä¸è¶³å¾…å¯æ”¹è¿›çš„åœ°æ–¹.</p>
<br>
<h2>Introduce</h2>
<p>é¦–å…ˆç®€å•ä»‹ç»ä¸‹ä¸¤ä¸ªé¡¹ç›®åŸºæœ¬ä¸šåŠ¡å’Œé€»è¾‘, å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿäº†è§£é¡¹ç›®éœ€æ±‚å’Œæ•´ä½“æ¶æ„.(å‘ç°å†™çš„æœ‰ç‚¹å¤šå¥½åƒä¸æ˜¯ç®€å•ä»‹ç»äº†- -)</p>
<br>
<h3>dbproxy</h3>
<p>ä¹‹å‰å…¬å¸åˆæœŸæœ‰å¤§é‡çš„phpé—ç•™ç³»ç»Ÿ, phpä¸­å¾ˆéš¾åšè¿æ¥æ± ,  é™¤äº†è¿™ä¸ªå¼ºéœ€æ±‚å¤–,  å¦‚æœæˆ‘ä»¬æœ‰äº†proxyï¼Œå¯ä»¥åœ¨mysqlä¸Šæ¸¸æ–¹é¢åšå¾ˆå¤š<a href="https://github.com/vitessio/vitess">ç±»ä¼¼å…¶ä»–proxyä¸€æ ·çš„cooläº‹æƒ…</a>,  æœ€ç†æƒ³æœ€ç»ˆæ„å»ºä¸€ä¸ªmysqlä¸Šâ€ç”¨æˆ·æ„Ÿè§‰åƒå•æœºä¸€æ ·â€çš„åˆ†å¸ƒå¼mysqlæ•°æ®åº“(- - å½“ç„¶è¿™éœ€è¦é…åˆmysqlæœ¬èº«æ”¹é€ å’Œä¸‹æ¸¸è®¾æ–½æ”¹é€ , æˆ‘ä¹ŸèŠ±äº†éƒ¨åˆ†ç²¾åŠ›å°è¯•äº†è§£ä¸‹æ¸¸binlogå’Œmysqlserveræœ¬èº«, å¹¶ä¸”è¿™æ˜¯æˆ‘çš„é•¿æœŸç›®æ ‡å“ˆ), å¯¹äºä¹‹å‰å…¬å¸çš„è§„æ¨¡çœ‹,  è‡ªç ”å¹¶ä¸”èƒ½æŒç»­æ”¹è¿›å‡çº§æ˜¯ä¸é”™çš„é€‰æ‹©, æ‰€ä»¥ä½¿ç”¨çº¯cç¼–å†™äº†ä¸€ä¸ªmysql proxy, ç›®æ ‡æ˜¯æ¥æ”¶ä¸šåŠ¡mysqlè¯·æ±‚, å¹¶æ ¹æ®è§„åˆ™é«˜æ•ˆåˆ†æ´¾åˆ°åç«¯mysqlä¸Šè¿è¡Œå¹¶åœ¨ç»“æŸåè¿”å›ç»“æœç»™ä¸šåŠ¡</p>
<br>
<h4>ä¸šåŠ¡æ¨¡å‹</h4>
<p>ä»ä¸šåŠ¡å’Œæ•´ä½“è§’åº¦æ˜¯è¿™æ ·çš„:</p>
<p><img src='Ruminations%20on%20proxy/IMG_0076.PNG'></p>
<ul><li>å¯¹å¤–é€šè¿‡å®ç°mysqlåè®®(<a href="https://dev.mysql.com/doc/internals/en/client-server-protocol.html">å®˜æ–¹æ–‡æ¡£</a>, <a href="https://github.com/lysu/mysql-server/blob/3d70e802c4650c93d5a69c1ebd477b40a94d6d1f/sql/protocol_classic.cc">mysqlæºç å®ç°</a>), ä¼ªè£…æˆä¸€ä¸ªmysqlæœåŠ¡å™¨å®Œæˆèº«ä»½æ ¡éªŒå¹¶å¼€å§‹æ¥æ”¶ä¸šåŠ¡è¯·æ±‚(ä¿è¯ä½¿ç”¨æ™®é€šä»»æ„mysqlå®¢æˆ·ç«¯å¯ä»¥è¿ä¸Š)
</li><li>æ”¶åˆ°å®¢æˆ·ç«¯ç«¯commandè¯·æ±‚åè§£æåŒ…å¤´type,  é¦–å…ˆæ ¹æ®typeåˆ¤æ–­æ˜¯å¯ä»¥åœ¨proxyå¤„ç†çš„å‘½ä»¤ï¼Ÿ è¿˜æ˜¯éœ€è¦è½¬å‘çš„(æ­£å¸¸çš„queryå’Œexecute)çš„å‘½ä»¤?å› ä¸ºä»å‰é¢åè®®æ–‡æ¡£å¯ä»¥çœ‹åˆ°åè®®æŒºå¤æ‚å¹¶éå•çº¯è½¬å‘å³å¯ï¼Œä¸€ä¸ªå¯ç”¨çš„mysql proxyéœ€è¦æå®šå¸¦çŠ¶æ€çš„éƒ¨åˆ†æŒ‡ä»¤
</li><li>å¯¹äºç¬¬ä¸€ç§æƒ…å†µ, å¦‚æœæ˜¯proxyæœ¬èº«éœ€è¦careçš„type, æ¯”å¦‚: å¯ä»¥ç›´æ¥è¿”å›çš„pingç­‰ / éœ€è¦æš‚æ—¶ç¼“å­˜çš„prepare or begin / æ”¹å˜proxyçŠ¶æ€çš„æŸäº›setå˜é‡ç­‰,  åˆ™ä¼šåœ¨proxyåšå¤„ç†æˆ–ç¼“å­˜, å…¶å®è¿™éƒ¨åˆ†ç»´æŠ¤çŠ¶æ€æ˜¯æ•´ä¸ªproxyæ¯”è¾ƒå¤æ‚ç»†èŠ‚ä½†è®©ä¸šåŠ¡æ„Ÿè§‰â€å’Œmysqlä¸€æ ·â€çš„å…³é”®
</li><li>å¯¹äºç¬¬äºŒç§æƒ…å†µï¼Œå¦‚æœæ˜¯æ­£å¸¸è½¬å‘çš„queryæˆ–execute/commit(åä¸¤ä¸ªä¼šå¸¦å‡ºä¹‹å‰ç¼“å­˜åœ¨proxyçš„ä¸€ç»„å‘½ä»¤)å‘½ä»¤, åˆ™ä¼šæŸ¥çœ‹è·¯ç”±é…ç½®ä¿¡æ¯å¦‚æœç›®æ ‡è¢«proxyçš„é›†ç¾¤æœ‰åˆ†ç‰‡åˆ™ä¼šç”¨parserè§£ææ‰¾åˆ°ç¡®å®šåˆ†ç‰‡mysqlé›†ç¾¤(æ¯ä¸ªé›†ç¾¤éƒ½æ˜¯1ä¸»å¤šä»)ï¼Œè€Œå¦‚æœé…ç½®çš„æ˜¯éåˆ†ç‰‡çš„åç«¯å¿½ç•¥parseråˆ™ç¡®å®šç›®æ ‡mysqlé›†ç¾¤; ç¡®å®šç›®æ ‡åˆ†ç‰‡é›†ç¾¤åæ ¹æ®å½“å‰æ˜¯è¯»è¿˜æ˜¯å†™å¹¶è€ƒè™‘äº‹åŠ¡ä¸Šä¸‹æ–‡hintç¡®å®šæ˜¯å°†sqlè½¬é›†ç¾¤ä¸­çš„masterè¿˜æ˜¯å¤šä¸ªslaveä¸­çš„ä¸€ä¸ª(è¿™é‡Œæ¶‰åŠä¸€ä¸ªload balancerçš„è¿‡ç¨‹)
</li><li>å¦‚æœæ˜¯åˆ†ç‰‡å¸¦åˆ†è¡¨çš„è¯, ä¼šæ ¹æ®hintåˆ©ç”¨sql parserå‡ºçš„çš„aståšè¡¨è¡¨årewriteç”Ÿæˆæ–°sql
</li><li>ç¡®å®šåç«¯æœºå™¨åä¼šä»ç»´æŠ¤çš„è¿æ¥æ± ä¸­è·å–ç©ºé—²è¿æ¥ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥åˆ™å‘èµ·å¼‚æ­¥æ–°å»ºä¸€ä¸ª(åŒæ—¶ç­‰å¾…è¿æ¥æ± åˆ«äººè¿”å›çš„)ï¼Œå¹¶ä¿è¯å¯¹mysqlå®Œæˆæ­£å¸¸æ ¡éªŒæ¡æ‰‹æ‰ç®—çœŸæ­£å»ºç«‹
</li><li>è·å–åç«¯è¿æ¥ååœ¨ç”¨æ ‡å‡†çš„mysqlåè®®å‘ç»™mysql-serverï¼Œå¹¶å¼‚æ­¥ç­‰å¾…è¿”å›ï¼Œå› ä¸ºè¿”å›æ•°æ®å¯èƒ½è¾ƒå¤§ï¼Œä¼šé‡‡ç”¨åˆ†æ®µå¤šæ¬¡è½¬å‘çš„æ–¹å¼å®Œæˆä»åç«¯è¿æ¥åˆ°å®¢æˆ·è¿æ¥çš„æ•°æ®æ¬è¿, å®Œæˆåç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªå®¢æˆ·è¯·æ±‚(mysqlçš„client-serveræ²¡æœ‰pipliningåŠŸèƒ½)
</li></ul>
<br>
<h4>è¿æ¥å¤„ç†</h4>
<p>ä»æŠ€æœ¯ä¸Šæˆ‘ä»¬ä½¿ç”¨Pure Cå®ç°, é€šè¿‡çº¿ç¨‹çš„å®ç°äº†ç±»ä¼¼nginxçš„acceptor-workerçš„æ¨¡å‹(ngæ˜¯è¿›ç¨‹, dbproxyæ˜¯çº¿ç¨‹)ï¼Œæ•´ä¸ªproxyæ˜¯åŸºäºepollå¤šè·¯å¤ç”¨çš„çš„æ— é˜»å¡çš„å¤„ç†, å› ä¸ºæ˜¯è½¬å‘åªæ²¡æœ‰è¿‡å¤šçš„çº¿ç¨‹åªæœ‰Nworkers+1accepter+1statisticä¸ªçº¿ç¨‹.</p>
<p><img src='Ruminations%20on%20proxy/IMG_0077.PNG'></p>
<ul><li>é¦–å…ˆmainå¯åŠ¨åä¼šè¯»å–é…ç½®, å¹¶åˆ›å»ºå¥½ä¸€ä¸ªacceptorçº¿ç¨‹å¯¹å¤–ç›‘å¬ç«¯å£, å¹¶é€šè¿‡epollç›‘å¬æ–°è¿æ¥, ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚
</li><li>åˆ›å»ºnä¸ªworkerçº¿ç¨‹å¹¶æš´éœ²ä¸€ä¸ªpipeç»™acceptorçº¿ç¨‹ç”¨äºåˆ†å‘, æ¯ä¸ªworkeræœ‰è‡ªå·±ç»´æŠ¤ä¸€ä¸ªepoll eventloopå¹¶ç›‘å¬pipe
</li><li>acceptoræ”¶åˆ°ç›‘å¬fdäº‹ä»¶åä¼š<code class='code-inline'>accept</code>å‡ºclientFdå¹¶é€šè¿‡pipe round-robinåˆ†å‘ç»™workerçº¿ç¨‹
</li><li>workeræ”¶åˆ°å°†æ–°fdåŠ å…¥è‡ªå·±çš„æœ¬çº¿ç¨‹çš„eventloop, å¹¶å¼€å§‹è§¦å‘å®¢æˆ·ç«¯æ ¡éªŒå’Œåç»­æ”¶å‘½ä»¤é€»è¾‘, åç»­è¿™ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«è¿™ä¸ªå›ºå®šçš„workerå¤„ç†.
</li><li>å¯¹äºè¢«ä»£ç†çš„mysqlä¼šé¦–å…ˆå°è¯•ä»ä¸€ä¸ªå…±äº«çš„çº¿ç¨‹æ± ä¸­è·å–è¿æ¥,  å¦‚æœæ²¡æœ‰ç©ºé—²åˆ™ä¼šé€šè¿‡å½“å‰çº¿ç¨‹çš„epollå»ºç«‹ä¸€ä¸ªæ–°è¿æ¥,  å¹¶åŠ å…¥å½“å‰çº¿ç¨‹eventloopï¼› å¦‚æœèƒ½ç›´æ¥ä»æ± å­ä¸­è·å–, åˆ™éœ€è¦åˆ¤æ–­æ˜¯å¦å’Œè¿˜å›å»æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯åˆ™éœ€è¦ä»è€eventloopç§»é™¤ï¼ŒåŠ å…¥å½“å‰çº¿ç¨‹çš„eventloop;åé¢ä¼šåœ¨æåˆ°è¿™ä¸ªè¿æ¥æ± ï¼Œéœ€è¦æ³¨æ„è¿æ¥å¹¶ééšæ„å¯å¤ç”¨ï¼Œä¸åŒæƒé™ä¸åŒcapacityçš„è¿æ¥ä¸èƒ½ä¸²
</li><li>åç»­writeå’Œç­‰mysql-serverè¿”å›é€šè¿‡å’Œå‰ç«¯è¿æ¥æ‰€å¤„çš„åŒä¸€ä¸ªeventloopä¸­å¼‚æ­¥å®Œæˆåˆ†æ®µå¤šæ¬¡è½¬å‘
</li></ul>
<br>
<h4>ä»£ç æ¨¡å‹</h4>
<p>ä»é€»è¾‘ä¸Šæ‰“å¹³äº†çš„æ¯ä¸ªworkerå¤„ç†é€»è¾‘å¯ä»¥ç†è§£ä¸ºè¿™æ ·â€¦</p>
<p><img src='Ruminations%20on%20proxy/97580A6A-762E-499F-9484-C89193F919C1.png'></p>
<p>å› ä¸ºä½¿ç”¨çº¯cå’Œé˜»å¡æ–¹å¼ç¼–å†™, æ‰€ä»¥ä»£ç ç»“æ„æ˜¯å¤§é‡å›è°ƒçš„, ä»é€»è¾‘ä¸Šçœ‹å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ä¸åœçš„<code class='code-inline'>epoll_wait</code>ç„¶åå¤„ç†å¼¹å‡ºçš„äº‹ä»¶å¹¶æ ¹æ®è¿æ¥çŠ¶æ€æœºè¿›è¡Œå¤„ç†é€»è¾‘åˆ†å‘ï¼Œå¤„ç†å®Œäº†å†è®¾æ³•è¿”å›åˆ°å¼€å§‹é‚£ä¸ª<code class='code-inline'>epoll_wait</code>çš„åœ°æ–¹ç»§ç»­å¤„ç†å…¶ä»–äº‹ä»¶(ps: epollä½¿ç”¨çš„æ˜¯level-triggerç¼–å†™ä¸Šæ€§å¯¹å®¹æ˜“)ï¼Œè™½ç„¶é€»è¾‘ä¸Šæ˜¯è¿™æ ·ä½†è¦åšä¸€ä¸ªå¯ç»´æŠ¤çš„ç³»ç»Ÿè‚¯å®šéœ€è¦æ ¹æ®é€»è¾‘è¿›è¡Œä¸€äº›åˆç†å»ºæ¨¡æ¥è®©äººæ›´å®¹æ˜“ç†è§£å¹¶æ–¹ä¾¿æœªæ¥ä¿®æ”¹, å½“æ—¶è‡ªå·±åˆšå¼€å§‹å­¦cï¼Œåœ¨ä¸šä½™å‘¨æœ«èŠ±æ—¶é—´å­¦ä¹ äº†cå’Œlinuxï¼Œå¤–è‡ªå·±ä¹ŸèŠ±äº†ç‚¹æ—¶é—´ç ”ç©¶äº†ä¸‹nginxï¼Œå¸Œæœ›çœ‹çœ‹åˆ«äººæ€ä¹ˆç»„ç»‡ä¸€ä¸ªç»å…¸çš„cç¨‹åº- -</p>
<br>
<p>å¼€å§‹ç¬¬ä¸€ç‰ˆæ‰“ç®—è£¸å†™epollï¼Œä½†åæ¥ä¸Šçº¿å‰æ¢ç”¨libevent(åªç”¨äº†libeventä¸­è–„å°è£…<code class='code-inline'>event_base</code>é‚£å±‚(åŸºæœ¬å’Œepollç±»ä¼¼ç”¨èµ·æ¥)å’Œtimer(timerä»£ç å®ç°å’Œnginxå¾ˆåƒçº¢é»‘æ ‘ç»´æŠ¤å¯ä»¥å‡å°‘æ²¡å¿…è¦çš„epollå¼¹å‡º), æ²¡æœ‰ç”¨æ¯”è¾ƒhighlevelçš„bufferé‚£å¥—), ä½†ä»£ç ç»“æ„è¿˜æ˜¯å„ç§å›è°ƒ, ä¸è¿‡æˆ‘è¿˜æ˜¯å°è¯•åœ¨å¯ç»´æŠ¤æ€§ä¸Šåšäº†ä¸€äº›åŠªåŠ›, è™½ç„¶æ˜¯Pure C, æˆ‘è¿˜æ˜¯å°è¯•ç”¨ç±»ä¼¼OOçš„æ–¹å¼æ¥ç»„ç»‡ä»£ç (ä¸€ä¸ªstructå’Œå›´ç»•structçš„ä¸€å †æ–¹æ³•), ä¸»è¦çš„domain modelæœ‰:</p>
<br>
<ul><li>cycle: çº¿ç¨‹å¯¹è±¡ç»´æŠ¤ä¸€äº›å¤„ç†çº¿ç¨‹ç›¸å…³çš„å˜é‡(ä»nginxä»£ç é‡Œå­¦çš„ğŸ˜†)
</li><li>acceptor/auth: å¯¹å‰ç«¯å®Œæˆæ–°å»ºè¿æ¥æ¥æ”¶å’Œé‰´æƒè®¤è¯
</li><li>front_connection: ä¸Šæ¸¸è¿æ¥ç›¸å…³å±æ€§,æ–¹æ³•çš„å°è£…
</li><li>back_connection: ä¸‹æ¸¸è¿æ¥ç›¸å…³å±æ€§, æ–¹æ³•çš„å°è£…(å…¶å®å’Œä¸Šé¢çš„æ‰©å±•, cæ²¡ç»§æ‰¿æˆ‘ç”¨ç±»ä¼¼ç»„åˆåšå¤ç”¨)
</li><li>conn_pool: å…±äº«è¿æ¥æ± , é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªkey->stackçš„æ˜ å°„, ä½†keyè®°å¾—æ¯”è¾ƒå¤æ‚æ˜¯ä¸€ä¸ªå¤šç»´çš„ç»„åˆ, å¤§æ¦‚æ˜¯â€é›†ç¾¤+ç”¨æˆ·+åŠ é“¾æ¥ç‰¹æ€§+ä¸»åº“orä»åº“â€æ¥å†³å®šstack, å› ä¸ºåŒä¸€ä¸ªé›†ç¾¤çš„è¿æ¥å¦‚æœæ˜¯ä¸åŒæƒé™ç”¨æˆ·ä¸èƒ½å¤ç”¨, è¿æ¥ç‰¹æ€§ä¸»è¦æ˜¯found_row, multi_query, ignore_spaceå¦‚æœä¸åŒä¹Ÿä¸èƒ½ä¸²â€¦è¿™æ˜¯mysql proxyæ¯”è¾ƒç»†èŠ‚ä½†å…³é”®çš„åœ°æ–¹
</li><li>core: mainæ–¹æ³•ä¸²è”ä¸Šè¯‰æµç¨‹å¹¶æ‰§è¡Œä¸€äº›proxyæœ¬èº«çš„ç»´æŠ¤æŒ‡ä»¤
</li><li>å…¶ä»–è¿˜æœ‰äº›ç±»ä¼¼: config, parser, router, logç­‰å›´ç»•connectionå¤„ç†æ¨¡å—
</li></ul>
<br>
<p>æ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªè‡ªå·±çš„<code class='code-inline'>.h</code>å’Œ<code class='code-inline'>.c</code>ï¼Œå¹¶éƒ½å†…èšçš„å›´ç»•domain model structç»´æŠ¤ä¸€ç»„å±•å¼€çš„æ–¹æ³•(å½“ç„¶ä¸å¯é¿å…çš„å¤„ç†å®Œåä¸€ç›´returnå›eventloopçš„é€»è¾‘), è¿™å‡ ä¸ªmodule(æ–‡ä»¶)é—´çš„é€»è¾‘å¯ä»¥ç†è§£ä¸ºè¿™æ ·(acceptorå…¶å®æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„cycle)</p>
<p><img src='Ruminations%20on%20proxy/IMG_0079.PNG'></p>
<br>
<h4>å°ç»“</h4>
<p>è¿™ä¸ªé¡¹ç›®æ˜¯æˆ‘ç¬¬ä¸€ç”¨çº¯cç¼–å†™å¤§å‹ç¨‹åº, ç¼–ç ä¸»è¦å°±æˆ‘ä¸€ä¸ªäºº, ä¸è¿‡æˆ‘leaderä¹‹å‰åœ¨baiduä¹Ÿæ˜¯ædbproxyçš„ä»–ç»™äº†æˆ‘å¾ˆå¤šæŒ‡å¯¼å¹¶å¸®æˆ‘review, ç‰¹åˆ«æ˜¯proxyæœ¬èº«å¯¹prepare<i>äº‹åŠ¡</i>setè¿˜æœ‰è¿æ¥èƒ½å¦å¤ç”¨ä¹‹ç±»çš„ç»†èŠ‚ç»éªŒè®©æˆ‘å°‘èµ°äº†å¾ˆå¤šå¼¯è·¯, è€Œè¿™ä¸ªé¡¹ç›®æ„Ÿè§‰ä¸šåŠ¡ä¸Šæœ€å¤æ‚ä¹Ÿå°±æ˜¯è¿™äº›è¾¹è§’ç»†èŠ‚çš„å¤„ç†åŒæ—¶ä¹Ÿæ˜¯å†³å®šæœ€ç»ˆæ•ˆæœçš„å…³é”®å› ç´ (è™½ç„¶è¿˜æ²¡å¼•å…¥èšåˆæˆ–åˆ†å¸ƒå¼äº‹åŠ¡å•çº¯åšç®€å•Partitionå’Œè¯»å†™åˆ†ç¦»ä¹Ÿæœ‰å¾ˆå¤šç»†èŠ‚å› ä¸ºmysqlæœ¬èº«äº¤äº’æ˜¯ä¸Šä¸‹æ–‡çŠ¶æ€çš„); å¦å¤–å°±æ˜¯è‡ªå·±åŠªåŠ›å°è¯•å°†å›è°ƒä»£ç åœ¨ä¸å¼•å…¥futureæˆ–coroutineçš„æƒ…å†µä¸‹å°½é‡æ˜“ç»´æŠ¤å˜æ›´(ä»åç»­æ–°åŒå­¦æ¥æ‰‹åé¦ˆçœ‹ä¸é”™)</p>
<br>
<h3>é•¿è¿æ¥gateway</h3>
<p>éœ€è¦å’Œå®¢æˆ·ç«¯ä¿æŒé•¿è¿æ¥,  ä¸»è¦åŠŸèƒ½æ˜¯å®¢æˆ·ç«¯èƒ½å¤ç”¨ä¿æŒçš„è¿æ¥å‘ä¸ŠPubUpä¿¡æ¯, è€Œä¸šåŠ¡èƒ½é€šè¿‡ä¿æŒçš„é•¿è¿æ¥å¯é ä¸‹æ¨æ¶ˆæ¯, ä»è€Œæ»¡è¶³å…¬å¸ä¸šåŠ¡ä¸Šå¯¹å¤§é‡çº¿ä¸‹è®¾å¤‡ä¸šåŠ¡çš„æ§åˆ¶å’Œä¸ŠæŠ¥éœ€æ±‚. åœ¨é•¿è¿œè®¾è®¡ä¸­gatewayæœªæ¥å¯ä»¥ä¾›ç»™æ‰‹æœºå®¢æˆ·ç«¯æ¥ä»£ç†æ‰€æœ‰æ‰‹æœºappä¸Šä¸‹è¡Œæµé‡.</p>
<br>
<p>å› ä¸ºå…¬å¸ä¸»è¦ä»¥javaæŠ€æœ¯æ ˆä¸ºä¸», æ‰€ä»¥ä¸»è¦ä½¿ç”¨javaå®ç°(è™½ç„¶æˆ‘ç ”äº†æ·˜å®, è…¾è®¯ç­‰ç±»ä¼¼é•¿è¿æ¥æ–¹æ¡ˆéƒ½æ˜¯c++ä½†è‡ªå·±è¿˜æ˜¯æœ‰ä¿¡å¿ƒèƒ½å®ç°æ»¡è¶³æ€§èƒ½è¾ƒå¥½çš„javaé•¿è¿æ¥),  åŸºäºjavaé‡Œæœ€æµè¡Œçš„ç½‘ç»œæ¡†æ¶nettyå®ç°ï¼Œä½†éé»‘ç›’ä½¿ç”¨, ç ”ç©¶äº†å¾ˆå¤šnettyæºç å¹¶å‚è€ƒäº†ä¹‹å‰dbproxyçš„æ€æƒ³ä¿è¯é«˜æ•ˆæ¥è¿‘cçš„æ¨¡å¼</p>
<br>
<p>åè®®ä¸Šæˆ‘ä»¬é€‰æ‹©åœ¨tcpä¸Šå®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„äºŒè¿›åˆ¶åè®®(packetç»“æ„: type bit + len of len bit + len bytes + playload bytes + checksum byteï¼Œç„¶åtypeæ˜¯æ›´ç²¾ç®€MQTTçš„handshake, pub, ack, ping, rstäº”è¯­ä¹‰)</p>
<br>
<h4>æ¨¡å—äº¤äº’</h4>
<p>ç›¸æ¯”ä¹‹å‰æˆ‘å¯¹gatewayæ ¹æ®åŠŸèƒ½èŒè´£åˆ’åˆ†äº†å¤šä¸ªå­æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥æ ¹æ®è´Ÿè½½ç‹¬ç«‹éƒ¨ç½²(å…¶ä¸­æ ¸å¿ƒæ¨¡å—åº”è¯¥å‡å°‘å‘å¸ƒå¯¼è‡´çš„æ–­çº¿å¯èƒ½)</p>
<br>
<p><img src='Ruminations%20on%20proxy/644B98C1-0751-434C-BEBF-C6F7AD2ABB95.png'></p>
<br>
<br>
<h5>Connsrv æ¥å…¥æ¨¡å—</h5>
<p>è´Ÿè´£ä¿æŒå’Œè®¾å¤‡çš„é“¾æ¥ã€‚ç»´æŠ¤å’Œè®¾å¤‡çš„é“¾æ¥ä¿¡æ¯å¹¶æ³¨å†Œåˆ°routerï¼›è½¬å‘è®¾å¤‡çš„ä¸Šè¡Œçš„æ•°æ®åˆ°ådispatcheræ¨¡å—ï¼›è½¬å‘pusherä¸‹æ¨è¯·æ±‚åˆ°ç›®æ ‡è®¾å¤‡é“¾æ¥ï¼›å¯¹å¤–å’Œå¯¹å†…éƒ½æš´éœ²TCPåè®®çš„æœåŠ¡.</p>
<br>
<ol start="1"><li>å»ºç«‹é“¾æ¥ï¼Œ connsrvå¯ä»¥éƒ¨ç½²é€šè¿‡éƒ¨ç½²å¤šä¸ªè¿›è¡Œæ¨ªå‘æ‰©å±•, è®¾å¤‡ç›®å‰é€šè¿‡4å±‚lvså¯¹å»ºç«‹é“¾æ¥æ“ä½œåˆ†å‘åˆ°å¤šä¸ªConnsrv(ç›®å‰åˆ†å‘ç­–ç•¥æ˜¯RoundRobin)å¹¶åœ¨å¯¹åº”çš„Connsrvä¸Šå»ºé“¾æˆåŠŸåè®¾å¤‡ä¼šä¸€ç›´ä¿æŒå’ŒConnsrvçš„é“¾æ¥ï¼Œåœ¨é“¾æ¥ä¸­æ–­å‰åç»­ä¸‹æ¨æˆ–ä¸Šå‘éƒ½åªä¼šé€šè¿‡è¿™å°Connsrvè¿›è¡Œã€‚
</li><li>æ¡æ‰‹æ ¡éªŒï¼Œ è®¾å¤‡å»ºç«‹tcpé“¾æ¥æˆåŠŸåä¼šå‘èµ·Handshake1è¯·æ±‚, æ”¶åˆ°handshake1åconnsrvä¼šåšæ ¡éªŒè®¾å¤‡, å¹¶æ³¨å†Œåˆ°routeræ¨¡å—, å¹¶è¿”å›Handshake2åˆ°è®¾å¤‡é€šçŸ¥è®¾å¤‡æ¡æ‰‹æˆåŠŸï¼Œå¹¶å‘ŠçŸ¥ä¼šè¯å¯†é’¥ï¼Œä¹‹åå°±å¯ä»¥ä¼ è¾“å’Œæ¥æ”¶ä¸‹æ¨æ•°æ®äº†
</li><li>è½¬å‘è®¾å¤‡ä¸Šè¡Œæ•°æ®ï¼Œè®¾å¤‡ä¸Šè¡Œæ•°æ®æ˜¯åŠ å¯†ï¼Œä¼šæ ¹æ®ä½¿ç”¨å¯¹åº”çš„ä¼šè¯å¯†é’¥è§£å¯†åï¼Œç¨ä½œå°è£…è½¬å‘åˆ°dispatcheræ¨¡å—ï¼Œå¹¶è½¬å‘dispatcherè¿”å›çš„ackæ•°æ®å›è®¾å¤‡
</li><li>è½¬å‘pushä¸‹æ¨æ•°æ®ï¼Œé€šè¿‡å†…å­˜ä¸­æœ¬åœ°ä¼šè¯æ‰¾åˆ°å¯¹åº”çš„é“¾æ¥ï¼ŒåŠ å¯†å¹¶è½¬å‘ä¸‹æ¨çš„æ•°æ®
</li><li>é“¾æ¥ä¸­æ–­ï¼Œconnsrvä¼šå‘routerè§£æ³¨å†Œå…¨å±€ä¼šè¯ä¿¡æ¯ï¼Œä»è€Œè®©å¤§å®¶éƒ½çŸ¥é“è¿™ä¸ªè®¾å¤‡å·²ç»ä¸‹çº¿
</li></ol>
<br>
<h5>Router è·¯ç”±æ¨¡å—</h5>
<p>è´Ÿè´£ç»´æŠ¤æ‰€æœ‰æ¥å…¥è®¾å¤‡çš„ä¼šè¯è·¯ç”±ä¿¡æ¯ï¼Œå®ç°ä¸Šæœ¬è´¨æ˜¯å¯¹redisçš„å°è£…ï¼Œä½†æœªæ¥HAå¯ä»¥åŒæ—¶ä½¿ç”¨å¤šç§å­˜å‚¨- -; å¯¹å¤–æš´éœ²éƒ½æ˜¯å¼‚æ­¥çš„dubboæœåŠ¡</p>
<br>
<ol start="1"><li>æ³¨å†Œè®¾å¤‡ï¼Œ ä¿å­˜è®¾å¤‡ä¼šè¯(uuid, connsrv-host, inflight, lastTs, ghost-flag)åˆ°redis
</li><li>ä¸‹çº¿è®¾å¤‡ï¼Œ è®¾ç½®è®¾å¤‡ä¼šè¯è¿‡æœŸæ—¶é—´ï¼Œç­‰å¾…è¿‡æœŸ
</li><li>å‰”é™¤è®¾å¤‡ï¼Œ Aè®¾å¤‡å·²é€šè¿‡Connsrv1æ³¨å†Œ, Aè®¾å¤‡å†æ¬¡é€šè¿‡Connsrv2æ³¨å†Œæ—¶ï¼ŒRouteréœ€è¦å‘Connsrv1ä¸»åŠ¨è¸¢æ‰è®¾å¤‡Aåœ¨Connsrv1çš„æœ¬åœ°ä¼šè¯, è¿™ä¸ªé€»è¾‘é€šè¿‡routeræ¨¡å—å®Œæˆ, å› ä¸ºæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæ“ä½œå¯èƒ½ä¼šä¸æˆåŠŸå¹¶å¯¼è‡´é‡å¤è¿æ¥ï¼Œä½†æœ€ç»ˆé€šè¿‡è¡¥å¿å’Œidleè¶…æ—¶å¯ä»¥ä¿è¯æœ€é•¿1sårouteræ•°æ®æ¢å¤å‡†ç¡®
</li></ol>
<br>
<h5>Pusher ä¸‹æ¨æ¨¡å—</h5>
<p>è´Ÿè´£æ¥æ”¶ä¸šåŠ¡çš„ä¸‹æ¨è¯·æ±‚ï¼Œå¯¹å¤–æš´éœ²dubboæ¥å£ï¼Œ å¯¹å†…æš´éœ²TCPæ¥å£, å®Œæˆ</p>
<br>
<ol start="1"><li>æ¥æ”¶ä¸‹æ¨æ¶ˆæ¯dubboè¯·æ±‚ï¼Œæ¥æ”¶ä¸šåŠ¡å‘èµ·çš„dubboè°ƒç”¨ï¼Œå‘routeræŸ¥æ‰¾è®¾å¤‡ä¼šè¯ï¼Œæ ¹æ®ä¼šè¯ä¸­çš„inflightä¿¡æ¯å†³å®šä¸‹æ¨é£è¡Œçª—å£å¤§å°ï¼Œ å¹¶æ ¹æ®ä¸‹æ¨æ¶ˆæ¯çš„QoSåˆ¤æ–­æ˜¯å¦æŒä¹…åŒ–æ¶ˆæ¯åˆ°mysql
</li><li>æ ¹æ®routeræ¨¡å—è®¾å¤‡ä¼šè¯ä¸­çš„connsrv-hostï¼Œä¸‹æ¨è¯·æ±‚åˆ°å¯¹åº”çš„connsrvæœåŠ¡å™¨
</li><li>å¦‚æœæ˜¯Qos=1çš„æ¶ˆæ¯æ¥å—é€šè¿‡TCPåè®®æ¥æ”¶ä¸‹æ¨åé¦ˆ(feedback)å’Œç¡®è®¤(ack), æ›´æ–°mysqlçŠ¶æ€
</li><li>è¿è¡Œå®šæ—¶ä»»åŠ¡1sä¸€æ¬¡æ‰«æmysqlä¸­é‡å‘æ¨é€å¤±è´¥å’Œè¶…æ—¶æœªåé¦ˆ/ç¡®è®¤çš„æ¶ˆæ¯
</li></ol>
<br>
<h5>Dispatcher åˆ†å‘æ¨¡å—</h5>
<p>è´Ÿè´£æ¥å—connsrvè½¬å‘ä¸Šæ¥çš„è®¾å¤‡ä¸ŠæŠ¥è¯·æ±‚ä¿¡æ¯ï¼Œ å¹¶è½¬å‘åˆ°mqä¸­ä¾›ä¸šåŠ¡è·å–; å¯¹å†…æä¾›TCPåè®®ï¼Œå¯¹å¤–æä¾›MQæœåŠ¡</p>
<br>
<ol start="1"><li>æ¥å—connsrvçš„ä¸ŠæŠ¥æ•°æ®ï¼Œæ ¹æ®wconfigé…ç½®çš„product->topicæ˜ å°„ï¼Œè½¬å‘æ¶ˆæ¯åˆ°mqçš„å¯¹åº”topic
</li><li>å‘é€æ¶ˆæ¯æˆåŠŸï¼Œåå¦‚æœæ˜¯Qos1ä¸ŠæŠ¥æ¶ˆæ¯ï¼Œä¼šå‘connsrvåé¦ˆackï¼Œackä¹‹åä¼šé€šè¿‡connsrvåé¦ˆå›è®¾å¤‡
</li></ol>
<br>
<h4>è¿æ¥å¤„ç†</h4>
<br>
<p>[gatewayçº¿ç¨‹]</p>
<br>
<p>è¿™é‡Œä¸»è¦å¯¹æ¯”ä»‹ç»ä¸‹gatewayä¸­connsrvçš„çº¿ç¨‹æ¨¡å‹ï¼Œå› ä¸ºä½¿ç”¨nettyï¼Œnettyé‡Œçº¿ç¨‹æ¨¡å‹ä¹Ÿæ˜¯å…¸å‹çš„acceptor-workeræ¨¡å¼,  æ‰€ä»¥è¿æ¥ç®¡ç†æµç¨‹å’Œdbproxyéå¸¸åƒ- -ï¼Œä½†å› ä¸ºæ˜¯é•¿è¿æ¥æœåŠ¡connsrvéœ€è¦ç»´æŠ¤ä¸€ä¸ªå‰ç«¯æ‰€æœ‰è®¾å¤‡è¿æ¥çš„æ˜ å°„, å¯¹åç«¯æœåŠ¡(è¿™é‡Œæ˜¯dispatcheræ¨¡å—)ä¹Ÿä¼šä¿æŒè¿æ¥æ± , ä½†gatewayé‡Œä¸åœ¨åšåˆ†workerçš„è¿æ¥æ± ï¼Œè¿™æ ·é¿å…äº†å¯¹è¿æ¥æ± çš„é”ç«äº‰å’Œé¢‘ç¹å¢å‡eventloopçš„ç³»ç»Ÿè°ƒç”¨.</p>
<br>
<h4>ä»£ç æ¨¡å‹</h4>
<p>åœ¨nettyæœ¬è´¨ä¹Ÿæ˜¯å¯¹epollçš„å°è£…(æˆ‘ä½¿ç”¨çš„æ˜¯<a href="https://github.com/netty/netty-tcnative">netty-native-port</a>ç”¨cåŸºäºepoll edge triggerå®ç°), æ²¡ç”¨javaçš„nio), æ‰€ä»¥æ ¸å¿ƒä¹Ÿæ˜¯å•çº¿ç¨‹çš„eventloopï¼Œä½†å¯¹äºå¤„ç†nettyä½¿ç”¨äº†piplineçš„patternï¼Œå¼¹å‡ºçš„äº‹ä»¶ä¼šè¢«ä¸€ä¸²handleré¡ºåºå¤„ç†.</p>
<br>
<p>æˆ‘ç¼–å†™äº†è‡ªå®šä¹‰ä¸€ç»„handler: logger, idleCheck, keepHeartbeat, packetEncoder, packetDecoder å’Œ æœ€ç»ˆçš„ ä¸šåŠ¡å¤„ç†handlerï¼Œ åœ¨epollå¼¹å‡ºè¯»äº‹ä»¶ånettyä¼šè¯»å–ç½‘ç»œåŒ…åˆ°bufferå¹¶é¡ºåºé€šè¿‡ä¸Šè¿°handlerï¼Œ ä¸¾ä¸ªä¾‹å­: decoderä¸€æ ·ä¹Ÿä¼šå®Œæˆç²˜åŒ…å¦‚æœæ²¡è¯»å…¨ç»§ç»­returnç»§ç»­ç­‰åç»­åŒ…ç­‰é€»è¾‘, æœ€ç»ˆåˆ°è¾¾ä¸šåŠ¡handlerå¾—åˆ°çš„å…¥å‚å°±æ˜¯ä¸€ä¸ªå®é™…çš„classå¯¹è±¡, ç›¸æ¯”ä¹‹å‰cå†™çš„dbproxyï¼Œå¯¹äºè¿æ¥æ£€æŸ¥ï¼Œæ—¥å¿—ï¼Œè¿˜æœ‰ç¼–è§£ç æ¨¡å—æ›´åŠ å•ä¸€èŒè´£ï¼Œæ„Ÿè§‰æ›´ä¼˜é›….</p>
<br>
<p>[gateway pipeline]</p>
<br>
<p>ä¸»è¦æ¨¡å‹æœ‰:(è®¾è®¡å³ä»£ç ä»£ç é‡Œä¹Ÿæœ‰å¯¹åº”ç±»)</p>
<br>
<p>[gatewayä»£ç ]</p>
<br>
<ul><li>downstream: å®¢æˆ·ç«¯ç®€å†çš„è¿æ¥ä¼šè¢«å°è£…ä¸ºä¸€ä¸ªdownstreamå¯¹è±¡, ç”¨äºç®¡ç†è¿æ¥çŠ¶æ€å¹¶æœ¬èº«ä½œä¸ºä¸€ä¸ªä¸šåŠ¡handleræ¥æ”¶nettyäº‹ä»¶å’Œæ”¶åˆ°çš„è¯·æ±‚
</li><li>commandProcessor: upstreamä¼šé€šè¿‡ä¸€ä¸ªcmdType->processorçš„æ³¨å†Œè¡¨æ¥æ‰¾åˆ°å…·ä½“çš„å¤„ç†processorï¼Œç›¸æ¯”dbproxyçš„switchæ›´ooä¸€äº›, processorè¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶è¿”å›futureï¼Œ é€šè¿‡futureä¸€å®šç¨‹åº¦ä¸Šå‡å°‘äº†è®¾æ³•è®©ä»£ç å›åˆ°eventloopçš„è„‘åŠ›æ¶ˆè€—æ›´åŠ ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘
</li><li>adaptor: ä¼šè´Ÿè´£æœåŠ¡å‘ç°ä¸Šæœ‰çš„clusterçš„åœ°å€å¹¶å®Œæˆè´Ÿè½½å‡è¡¡æ‰¾åˆ°å…¶ä¸­æŸnode
</li><li>upstreamPool: åç«¯è¿æ¥æ± ï¼Œç›¸æ¯”dbproxyè¿™ä¸ªpoolæ˜¯threadloacalçš„å¯ä»¥æ— é”æ“ä½œçš„è¿æ¥æ± , ä¹Ÿä¸éœ€è¦åšè·¨eventloopä½¿ç”¨è¿æ¥æ—¶çš„2æ¬¡ç¹é‡çš„ç³»ç»Ÿè°ƒç”¨
</li><li>upstream: æ˜¯å…·ä½“åç«¯è¿æ¥å¯¹è±¡ï¼Œè¿™é‡Œå°è£…äº†ä¸Šæ¸¸è¿æ¥çš„çŠ¶æ€, å¹¶ä¹Ÿä½œä¸ºä¸€ä¸ªä¸šåŠ¡handlerå¤„ç†nettyä¼ è¿‡æ¥çš„å„ç§äº‹ä»¶å¤„ç†å›è°ƒ, å¹¶æ”¯æŒåƒåç«¯å¼‚æ­¥å»ºç«‹è¿æ¥ï¼Œå†™æ•°æ®ï¼Œæ”¶è¿”å›æ•°æ®
</li></ul>
<br>
<p>æ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„javaç±», å›´ç»•downstreamå’Œupstreamæ ¹æ®æŒ‡ä»¤æ³¨å†Œä¸€ç»„processorç›¸æ¯”ä¸Šæ¬¡æ„Ÿè§‰ä»£ç æ›´åŠ æ¸…æ™°</p>
<br>
<h2>Interesting detail</h2>
<p>æœ¬èŠ‚è¿›å…¥ä¸»é¢˜çœ‹ä¸‹ä¸¤ä¸ªproxyä¸­è‡ªå·±è§‰å¾—æŒºæœ‰æ„æ€çš„ç»†èŠ‚è®¾è®¡, ç‰¹åˆ«æ˜¯ç¬¬äºŒæ¬¡ä¸­å¯¹ä¹‹å‰çš„æ”¹è¿›ä¼˜åŒ–</p>
<br>
<h3>å†…å­˜åˆ†é…</h3>
<p>ä½œä¸ºproxyå®Œæˆçš„æ ¸å¿ƒä»»åŠ¡å°±æ˜¯å¯¹ä¸¤ç«¯socketçš„æ•°æ®è½¬å‘, åˆ©ç”¨epollå’Œæ— é˜»å¡ioå¹¶æ§åˆ¶æœ‰æ•ˆçº¿ç¨‹æ•°èƒ½å……åˆ†åˆ©ç”¨cpuï¼Œç³»ç»Ÿç“¶é¢ˆå°±æ›´å¤šä¼šåœ¨å†…å­˜æ“ä½œä¸Šï¼Œé¦–å…ˆé¢‘ç¹çš„å†…å­˜åˆ†é…ä¼šä¸€å®šç¨‹åº¦çš„é˜»å¡cpu(kernelåœ¨å®é™…åˆ†é…é¡µæ˜¯é˜»å¡çš„), å¦å¤–å¤šçº¿ç¨‹åˆ†é…ä¹Ÿä¼šåœ¨kernelæœ‰ç«äº‰é˜»å¡æ¡ä»¶ï¼Œæœ€ååœ¨ç¬¬äºŒä¸ªio gatewayä¸­å› ä¸ºæ˜¯ä½¿ç”¨jvmè¿™æ ·å¸¦gcçš„è™šæ‹Ÿæœºä¸Šè¯­è¨€, å¯¹äºå¤§é‡æ•°æ®åˆ†é…åçš„å›æ”¶å‹åŠ›ä¹Ÿä¼šæ¶ˆè€—å¤§é‡cpuï¼ŒåŒæ—¶å†…å­˜æœ¬èº«é™åˆ¶ä¹Ÿå®¹æ˜“æˆä¸ºç³»ç»Ÿcrashçš„é£é™©æ¡ä»¶, å…¶ä¸­æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸‹ç”¨äºè½¬ç§»æ•°æ®bufferçš„åˆ†é…é€»è¾‘</p>
<br>
<p>é¦–å…ˆ, å…ˆçœ‹ä¸‹dbproxyï¼Œå› ä¸ºæ˜¯cç¨‹åº, éœ€è¦è‡ªå·±ç®¡ç†é‡Šæ”¾å†…å­˜, å¯¹äºéœ€è¦åˆ†é…çš„bufferå†…å­˜</p>
<br>
<br>
<br>

        </div>
        <script type="text/javascript">
            (function() {

    var doc_ols = document.getElementsByTagName("ol");

    for ( i=0; i<doc_ols.length; i++) {

        var ol_start = doc_ols[i].getAttribute("start") - 1;
        doc_ols[i].setAttribute("style", "counter-reset:ol " + ol_start + ";");

    }

})();
        </script>
        <style>
            html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;font-size:100%;vertical-align:baseline}html{line-height:1}ol,ul{list-style:none}table{border-collapse:collapse;border-spacing:0}caption,th,td{text-align:left;font-weight:normal;vertical-align:middle}q,blockquote{quotes:none}q:before,q:after,blockquote:before,blockquote:after{content:"";content:none}a img{border:none}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}*{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}html{font-size:87.5%;line-height:1.57143em}html{font-size:14px;line-height:1.6em;-webkit-text-size-adjust:100%}body{background:#fcfcfc;color:#545454;text-rendering:optimizeLegibility;font-family:"AvenirNext-Regular"}a{color:#de4c4f;text-decoration:none}h1{font-family:"AvenirNext-Medium";color:#333;font-size:1.6em;line-height:1.3em;margin-bottom:.78571em}h2{font-family:"AvenirNext-Medium";color:#333;font-size:1.3em;line-height:1em;margin-bottom:.62857em}h3{font-family:"AvenirNext-Medium";color:#333;font-size:1.15em;line-height:1em;margin-bottom:.47143em}p{margin-bottom:1.57143em;hyphens:auto}hr{height:1px;border:0;background-color:#dedede;margin:-1px auto 1.57143em auto}ul,ol{margin-bottom:.31429em}ul ul,ul ol,ol ul,ol ol{margin-bottom:0px}ol li:before{content:counter(ol) ".";counter-increment:ol;color:#e06e73;text-align:right;display:inline-block;min-width:1em;margin-right:0.5em}b,strong{font-family:"AvenirNext-Bold"}i,em{font-family:"AvenirNext-Italic"}code{font-family:"Menlo-Regular"}.text-overflow-ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.sf_code_syntax_string{color:#D33905}.sf_code_syntax_comment{color:#838383}.sf_code_syntax_documentation_comment{color:#128901}.sf_code_syntax_number{color:#0E73A2}.sf_code_syntax_project{color:#5B2599}.sf_code_syntax_keyword{color:#0E73A2}.sf_code_syntax_character{color:#1B00CE}.sf_code_syntax_preprocessor{color:#920448}.note-wrapper{max-width:46em;margin:0px auto;padding:1.57143em 3.14286em}.note-wrapper.spotlight-preview{overflow-x:hidden}u{text-decoration:none;background-image:linear-gradient(to bottom, rgba(0,0,0,0) 50%,#e06e73 50%);background-repeat:repeat-x;background-size:2px 2px;background-position:0 1.05em}s{color:#878787}p{margin-bottom:0.1em}hr{margin-bottom:0.7em;margin-top:0.7em}ul li{text-indent:-0.35em}ul li:before{content:"â€¢";color:#e06e73;display:inline-block;margin-right:0.3em}ul ul{margin-left:1.25714em}ol li{text-indent:-1.45em}ol ol{margin-left:1.25714em}blockquote{display:block;margin-left:-1em;padding-left:0.8em;border-left:0.2em solid #e06e73}.todo-list ul{margin-left:1.88571em}.todo-list li{text-indent:-1.75em}.todo-list li:before{content:"";display:static;margin-right:0px}.todo-checkbox{text-indent:-1.7em}.todo-checkbox svg{margin-right:0.3em;position:relative;top:0.2em}.todo-checkbox svg #check{display:none}.todo-checkbox.todo-checked #check{display:inline}.todo-checkbox.todo-checked .todo-text{text-decoration:line-through;color:#878787}.code-inline{display:inline;background:white;border:solid 1px #dedede;padding:0.2em 0.5em;font-size:0.9em}.code-multiline{display:block;background:white;border:solid 1px #dedede;padding:0.7em 1em;font-size:0.9em;overflow-x:auto}.hashtag{display:inline-block;color:white;background:#b8bfc2;padding:0.0em 0.5em;border-radius:1em;text-indent:0}.hashtag a{color:#fff}.address a{color:#545454;background-image:linear-gradient(to bottom, rgba(0,0,0,0) 50%,#0da35e 50%);background-repeat:repeat-x;background-size:2px 2px;background-position:0 1.05em}.address svg{position:relative;top:0.2em;display:inline-block;margin-right:0.2em}.color-preview{display:inline-block;width:1em;height:1em;border:solid 1px rgba(0,0,0,0.3);border-radius:50%;margin-right:0.1em;position:relative;top:0.2em;white-space:nowrap}.color-code{margin-right:0.2em;font-family:"Menlo-Regular";font-size:0.9em}.color-hash{opacity:0.4}.ordered-list-number{color:#e06e73;text-align:right;display:inline-block;min-width:1em}.arrow svg{position:relative;top:0.08em;display:inline-block;margin-right:0.15em;margin-left:0.15em}.arrow svg #rod{stroke:#545454}.arrow svg #point{fill:#545454}mark{color:inherit;display:inline-block;padding:0px 4px;background-color:#fcffc0}img{max-width:100%;height:auto}

        </style>
    </body>
</html>
